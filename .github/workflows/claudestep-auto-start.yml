name: ClaudeStep Auto-Start

# Automatic project detection workflow for ClaudeStep.
#
# This workflow detects new projects when spec.md files are pushed and outputs
# the project list for the run-claudestep job to process. It does NOT trigger
# workflows directly - instead, it passes project information via job outputs.
#
# Flow:
# 1. Push event triggers this workflow when spec.md files change
# 2. Python command detects which projects are new (no existing PRs)
# 3. Project list is output for downstream consumption
# 4. The run-claudestep job (in claudestep.yml) processes projects sequentially
#
# This workflow is branch-agnostic:
# - When a spec is pushed to 'main', PRs target 'main'
# - When a spec is pushed to 'main-e2e', PRs target 'main-e2e'
# - Works on any branch
#
# Security considerations:
# - Only triggers on push events (requires write access to push)
# - Path filter limits to spec.md files in claude-step/ directory
# - Cannot be triggered by PRs (PR branches don't trigger push events on protected branches)
# - AUTO_START_ENABLED variable allows repository admins to disable if needed
# - Branch names with special characters are handled safely (no shell injection)
on:
  push:
    branches:
      - '**'  # Trigger on ANY branch
    paths:
      - 'claude-step/*/spec.md'

concurrency:
  group: claudestep-auto-start-${{ github.ref }}
  cancel-in-progress: false  # Let both run, they'll detect existing PRs

jobs:
  auto-start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ClaudeStep
        run: pip install -e .

      - name: Log derived base branch
        run: |
          echo "Auto-start triggered on branch: ${{ github.ref_name }}"
          echo "PRs will target base branch: ${{ github.ref_name }}"

      - name: Detect and trigger auto-start
        id: auto_start
        run: python3 -m claudestep auto-start
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          # Derive base branch from the branch that was pushed to (works on any branch)
          BASE_BRANCH: ${{ github.ref_name }}
          REF_BEFORE: ${{ github.event.before }}
          REF_AFTER: ${{ github.sha }}
          GH_TOKEN: ${{ github.token }}
          AUTO_START_ENABLED: ${{ vars.CLAUDESTEP_AUTO_START_ENABLED != 'false' }}

      - name: Generate summary
        if: always()
        run: |
          echo "# ClaudeStep Auto-Start Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PROJECTS="${{ steps.auto_start.outputs.projects_to_trigger }}"
          COUNT="${{ steps.auto_start.outputs.project_count }}"

          if [ -z "$PROJECTS" ] || [ "$COUNT" = "0" ]; then
            echo "No new projects detected that need processing." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This can happen when:" >> $GITHUB_STEP_SUMMARY
            echo "- No spec.md files were changed in this push" >> $GITHUB_STEP_SUMMARY
            echo "- Changed projects already have existing PRs" >> $GITHUB_STEP_SUMMARY
            echo "- Auto-start is disabled via CLAUDESTEP_AUTO_START_ENABLED variable" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Projects to process ($COUNT):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for project in $PROJECTS; do
            echo "- \`$project\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The run-claudestep job will process these projects sequentially." >> $GITHUB_STEP_SUMMARY
